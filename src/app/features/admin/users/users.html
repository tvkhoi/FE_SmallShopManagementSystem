<div class="users-container">
    <!-- Header -->
    <div class="users-header">
        <h2>Người dùng</h2>
        <div class="user-header__actions">
            <button nz-button nzType="primary" (click)="showModal()">Thêm người dùng</button>
        </div>
    </div>

    <!-- Modal: Gán quyền cho user mới -->
    <nz-modal [(nzVisible)]="isVisible" [nzTitle]="isEditMode ? 'Sửa người dùng' : 'Thêm người dùng'"
        (nzOnCancel)="handleCancel()" [nzOkLoading]="isConfirmLoading" [nzFooter]="modalFooter"
        [nzBodyStyle]="{ 'max-height': '60vh', 'overflow-y': 'auto' }">
        <div *nzModalContent>
            <nz-tabs>
                <nz-tab nzTitle="Thông tin người dùng">
                    <form nz-form [nzLayout]="'vertical'" #userForm="ngForm">

                        <!-- Username -->
                        <nz-form-item>
                            <nz-form-label [nzRequired]="true" nzFor="username">Tên đăng nhập</nz-form-label>
                            <nz-form-control [nzErrorTip]="'Tên đăng nhập là bắt buộc'">
                                <input nz-input id="username" name="username" [(ngModel)]="newUser.username" required
                                    placeholder="Nhập tên đăng nhập" [disabled]="isEditMode" />
                            </nz-form-control>
                        </nz-form-item>

                        <!-- Email -->
                        <nz-form-item>
                            <nz-form-label [nzRequired]="true" nzFor="email">Email</nz-form-label>
                            <nz-form-control
                                [nzErrorTip]="emailRef.errors?.['required'] ? 'Vui lòng nhập email': emailRef.errors?.['email'] ? 'Vui lòng nhập email hợp lệ': ''">
                                <input nz-input type="email" id="email" name="email" [(ngModel)]="newUser.email"
                                    required email #emailRef="ngModel" placeholder="Nhập email"
                                    [disabled]="isEditMode" />
                            </nz-form-control>
                        </nz-form-item>


                        <!-- Họ và tên -->
                        <nz-form-item>
                            <nz-form-label nzFor="fullName">Họ và tên</nz-form-label>
                            <nz-form-control>
                                <input nz-input id="fullName" name="fullName" [(ngModel)]="newUser.fullName"
                                    placeholder="Nhập họ và tên" />
                            </nz-form-control>
                        </nz-form-item>

                        <!-- Số điện thoại -->
                        <nz-form-item>
                            <nz-form-label nzFor="phoneNumber">Số điện thoại</nz-form-label>
                            <nz-form-control>
                                <input nz-input type="tel" id="phoneNumber" name="phoneNumber"
                                    [(ngModel)]="newUser.phoneNumber" placeholder="Nhập số điện thoại" />
                            </nz-form-control>
                        </nz-form-item>

                        <!-- Địa chỉ -->
                        <nz-form-item>
                            <nz-form-label nzFor="address">Địa chỉ</nz-form-label>
                            <nz-form-control>
                                <input nz-input id="address" name="address" [(ngModel)]="newUser.address"
                                    placeholder="Nhập địa chỉ" />
                            </nz-form-control>
                        </nz-form-item>

                        <!-- Mật khẩu -->
                        <nz-form-item>
                            <nz-form-label [nzRequired]="true" nzFor="password">Mật khẩu</nz-form-label>
                            <nz-form-control>
                                <nz-input-group [nzSuffix]="suffixIcon">
                                    <input nz-input [type]="passwordVisible ? 'text' : 'password'" id="password"
                                        name="password" [(ngModel)]="newUser.password" placeholder="Nhập mật khẩu"
                                        required [disabled]="isEditMode" />
                                </nz-input-group>
                                <ng-template #suffixIcon>
                                    <span nz-icon [nzType]="passwordVisible ? 'eye-invisible' : 'eye'"
                                        (click)="passwordVisible = !passwordVisible" style="cursor: pointer;"></span>
                                </ng-template>
                            </nz-form-control>
                        </nz-form-item>

                        <!-- Xác nhận mật khẩu -->
                        <nz-form-item *ngIf="!isEditMode">
                            <nz-form-label [nzRequired]="true" nzFor="confirmPassword">Nhập lại mật khẩu</nz-form-label>
                            <nz-form-control [nzErrorTip]="'Mật khẩu không khớp'">
                                <input nz-input [type]="confirmPasswordVisible ? 'text' : 'password'"
                                    id="confirmPassword" name="confirmPassword" [(ngModel)]="confirmPassword"
                                    placeholder="Nhập lại mật khẩu" required
                                    [ngClass]="{'input-error': confirmPassword && confirmPassword !== newUser.password}" />
                                <span nz-icon [nzType]="confirmPasswordVisible ? 'eye-invisible' : 'eye'"
                                    (click)="confirmPasswordVisible = !confirmPasswordVisible"
                                    style="cursor: pointer; position: absolute; right: 10px; top: 8px;">
                                </span>
                            </nz-form-control>
                        </nz-form-item>



                        <!-- Trạng thái -->
                        <nz-form-item>
                            <nz-form-label nzFor="isActive">Trạng thái</nz-form-label>
                            <nz-form-control>
                                <nz-switch id="isActive" name="isActive" [(ngModel)]="newUser.isActive"
                                    [nzCheckedChildren]="'Kích hoạt'" [nzUnCheckedChildren]="'Khóa'">
                                </nz-switch>
                            </nz-form-control>
                        </nz-form-item>
                    </form>
                </nz-tab>

                <nz-tab nzTitle="Quyền hạn">
                    <form nz-form [nzLayout]="'vertical'">
                        <nz-form-item>
                            <nz-form-label>Chọn vai trò</nz-form-label>
                            <nz-form-control>
                                <div *ngFor="let role of roles">
                                    <label nz-checkbox [(ngModel)]="role.checked" name="{{ role.name }}"
                                        (ngModelChange)="onChangeRoleSelection()">
                                        {{ role.name }}
                                    </label>
                                </div>
                            </nz-form-control>
                        </nz-form-item>
                    </form>
                </nz-tab>
            </nz-tabs>
        </div>
    </nz-modal>

    <!-- Modal: Assign permissions -->
    <app-assign-permission-modal [visible]="isAssignVisible" [user]="selectedUser"
        [groupedPermissions]="groupedPermissions" (cancel)="handleAssignCancel()"
        (save)="handleAssignOk($event)"></app-assign-permission-modal>

    <nz-modal [(nzVisible)]="isViewDetailsVisible" nzTitle="Xem chi tiết" (nzOnCancel)="handleViewDetailsCancel()"
        [nzOkLoading]="isConfirmLoading" [nzFooter]="modalFooterViewDetails">
        <div *nzModalContent>
            <table class="details-table">
                <tr>
                    <td class="label">Mã người dùng</td>
                    <td>{{ selectedUser?.id }}</td>
                </tr>
                <tr>
                    <td class="label">Tên đăng nhập</td>
                    <td>{{ selectedUser?.username }}</td>
                </tr>
                <tr>
                    <td class="label">Họ và tên</td>
                    <td>{{ selectedUser?.fullName }}</td>
                </tr>
                <tr>
                    <td class="label">Email</td>
                    <td>{{ selectedUser?.email }}</td>
                </tr>
                <tr>
                    <td class="label">Số điện thoại</td>
                    <td>{{ selectedUser?.phoneNumber }}</td>
                </tr>
                <tr>
                    <td class="label">Địa chỉ</td>
                    <td class="address-cell">{{ selectedUser?.address }}</td>
                </tr>
                <tr>
                    <td class="label">Ngày tạo</td>
                    <td>{{ selectedUser?.createdAt | date:'dd/MM/yyyy HH:mm:ss' }}</td>
                </tr>
                <tr>
                    <td class="label">Trạng thái</td>
                    <td>
                        <nz-tag [nzColor]="selectedUser?.isActive ? 'green' : 'red'">
                            {{ selectedUser?.isActive ? 'Kích hoạt' : 'Không kích hoạt' }}
                        </nz-tag>
                    </td>
                </tr>
            </table>
        </div>
    </nz-modal>

    <nz-modal [(nzVisible)]="isChangePasswordVisible" nzTitle="Đặt lại mật khẩu"
        (nzOnCancel)="handleCancelChangePassword()" [nzFooter]="changePasswordFooter">
        <div *nzModalContent>
            <form #changePasswordForm="ngForm" nz-form nzLayout="horizontal">

                <!-- Mật khẩu mới -->
                <nz-form-item>
                    <nz-form-label style="text-align: left;" [nzRequired]="true" nzFor="newPassword" [nzSpan]="7">
                        Mật khẩu mới
                    </nz-form-label>
                    <nz-form-control [nzSpan]="18">
                        <nz-input-group [nzSuffix]="suffixNewPwdIcon">
                            <input nz-input [type]="passwordVisible ? 'text' : 'password'" id="newPassword"
                                name="newPassword" [(ngModel)]="changePassword.newPassword" required
                                placeholder="Nhập mật khẩu mới" />
                        </nz-input-group>
                        <ng-template #suffixNewPwdIcon>
                            <span nz-icon [nzType]="passwordVisible ? 'eye-invisible' : 'eye'"
                                (click)="passwordVisible = !passwordVisible" style="cursor: pointer;"></span>
                        </ng-template>
                    </nz-form-control>
                </nz-form-item>

                <!-- Nhập lại mật khẩu -->
                <nz-form-item>
                    <nz-form-label style="text-align: left;" [nzRequired]="true" nzFor="confirmPassword" [nzSpan]="7">
                        Nhập lại mật khẩu
                    </nz-form-label>
                    <nz-form-control [nzSpan]="18" [nzErrorTip]="'Mật khẩu không khớp'">
                        <nz-input-group [nzSuffix]="suffixConfirmPwdIcon">
                            <input nz-input [type]="confirmPasswordVisible ? 'text' : 'password'" id="confirmPassword"
                                name="confirmPassword" [(ngModel)]="confirmPassword" required
                                placeholder="Nhập lại mật khẩu" />
                        </nz-input-group>
                        <ng-template #suffixConfirmPwdIcon>
                            <span nz-icon [nzType]="confirmPasswordVisible ? 'eye-invisible' : 'eye'"
                                (click)="confirmPasswordVisible = !confirmPasswordVisible"
                                style="cursor: pointer;"></span>
                        </ng-template>
                    </nz-form-control>
                </nz-form-item>

            </form>
        </div>
    </nz-modal>

    <!-- Footer -->
    <ng-template #changePasswordFooter>
        <button nz-button nzType="default" (click)="handleCancelChangePassword()">Hủy</button>
        <button nz-button nzType="primary" (click)="handleOkChangePassword()" [disabled]="!changePassword.newPassword">
            Đặt lại mật khẩu
        </button>
    </ng-template>



    <ng-template #modalFooter>
        <button nz-button nzType="default" (click)="handleCancel()">Hủy</button>
        <button nz-button nzType="primary" (click)="handleOk()" [nzLoading]="isConfirmLoading">Lưu</button>
    </ng-template>

    <ng-template #modalFooterViewDetails>
        <button style="width: 100%;" nz-button nzType="primary" (click)="handleViewDetailsCancel()">Đóng</button>
    </ng-template>

    <!-- Search -->
    <div class="search-bar" style="display: flex; gap: 8px; align-items: center; margin-bottom: 16px;">
        <nz-input-group>
            <input type="text" nz-input placeholder="Tìm kiếm" [(ngModel)]="searchQuery" />
        </nz-input-group>
        <button nz-button nzType="primary" (click)="filterUsers()">
            <i nz-icon nzType="search"></i> Tìm kiếm
        </button>
    </div>

    <!-- Bộ lọc -->
    <div class="filter-container">
        <form nz-form nzLayout="vertical" class="filter-grid">
            <!-- Email -->
            <nz-form-item>
                <nz-form-label>Email</nz-form-label>
                <nz-form-control>
                    <input nz-input [(ngModel)]="filters.email" name="email" placeholder="Nhập email" />
                </nz-form-control>
            </nz-form-item>

            <!-- Username -->
            <nz-form-item>
                <nz-form-label>Tên đăng nhập</nz-form-label>
                <nz-form-control>
                    <input nz-input [(ngModel)]="filters.username" name="username" placeholder="Nhập username" />
                </nz-form-control>
            </nz-form-item>

            <!-- Số điện thoại -->
            <nz-form-item>
                <nz-form-label>SĐT</nz-form-label>
                <nz-form-control>
                    <input nz-input [(ngModel)]="filters.phone" name="phone" placeholder="Nhập số điện thoại" />
                </nz-form-control>
            </nz-form-item>

            <!-- Họ tên -->
            <nz-form-item>
                <nz-form-label>Họ tên</nz-form-label>
                <nz-form-control>
                    <input nz-input [(ngModel)]="filters.fullName" name="fullName" placeholder="Nhập họ tên" />
                </nz-form-control>
            </nz-form-item>

            <!-- Địa chỉ -->
            <nz-form-item>
                <nz-form-label>Địa chỉ</nz-form-label>
                <nz-form-control>
                    <input nz-input [(ngModel)]="filters.atDress" name="atDress" placeholder="Nhập địa chỉ" />
                </nz-form-control>
            </nz-form-item>

            <!-- Trạng thái -->
            <nz-form-item>
                <nz-form-label>Trạng thái</nz-form-label>
                <nz-form-control>
                    <nz-select [(ngModel)]="filters.isActive" name="isActive" style="width: 100%;">
                        <nz-option [nzValue]="true" nzLabel="Kích hoạt"></nz-option>
                        <nz-option [nzValue]="false" nzLabel="Không kích hoạt"></nz-option>
                    </nz-select>
                </nz-form-control>
            </nz-form-item>

            <!-- Ngày tạo -->
            <nz-form-item>
                <nz-form-label>Ngày tạo</nz-form-label>
                <nz-form-control>
                    <input nz-input type="date" [(ngModel)]="filters.createdAt" name="createdAt" />
                </nz-form-control>
            </nz-form-item>

            <!-- Buttons -->
            <nz-form-item class="filter-buttons" style="grid-column: span 4;">
                <button nz-button nzType="primary" (click)="applyFilter()" style="margin-right: 8px;">Lọc</button>
                <button nz-button (click)="resetFilter()">Làm mới</button>
            </nz-form-item>
        </form>
    </div>




    <!-- Table -->
    <nz-table #userTable [nzData]="users" [nzFrontPagination]="false" class="user-table">
        <thead>
            <tr>
                <th nzWidth="10%">Hành động</th>
                <th nzWidth="12%">Tên người dùng</th>
                <th nzWidth="14%">Họ và tên</th>
                <th nzWidth="18%">Địa chỉ email</th>
                <th nzWidth="12%">Số điện thoại</th>
                <th nzWidth="14%">Địa chỉ</th>
                <th nzWidth="12%">Ngày tạo</th>
                <th nzWidth="8%">Trạng thái</th>

            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let user of userTable.data">
                <td>
                    <a class="action-dropdown" nz-dropdown [nzDropdownMenu]="menu">
                        <nz-icon nzType="setting" nzTheme="outline"
                            style="font-size: 16px; padding-right: 5px;"></nz-icon>
                        Hành động
                    </a>
                    <nz-dropdown-menu #menu="nzDropdownMenu">
                        <ul nz-menu>
                            <li nz-menu-item><button nz-button nzType="link" (click)="viewDetails(user)">Xem chi
                                    tiết</button></li>
                            <li nz-menu-item><button nz-button nzType="link" (click)="editUser(user)"
                                    [disabled]="user.id===1">Sửa</button></li>
                            <li nz-menu-item><button nz-button nzType="link" (click)="showAssignModal(user)"
                                    [disabled]="user.id===1">Gán
                                    quyền</button></li>
                            <li nz-menu-item><button nz-button nzType="link" (click)="deleteUser(user)"
                                    [disabled]="user.id===1">Xóa</button>
                            </li>
                            <li nz-menu-item><button nz-button nzType="link" (click)="showChangePasswordModal(user)"
                                    [disabled]="user.id===1">Đặt lại mật khẩu</button>
                            </li>
                            <li nz-menu-item>
                                <button nz-button nzType="link" (click)="toggleLock(user)" [disabled]="user.id === 1">
                                    {{ user.isActive ? 'Khóa' : 'Mở khóa' }}
                                </button>
                            </li>

                        </ul>
                    </nz-dropdown-menu>
                </td>
                <td>{{ user.username }}</td>
                <td>{{ user.fullName }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.phoneNumber }}</td>
                <td>
                    <span class="ellipsis" nz-tooltip [nzTooltipTitle]="user.address">
                        {{ user.address }}
                    </span>
                </td>

                <td>{{ user.createdAt | date:'dd/MM/yyyy HH:mm:ss' }}</td>
                <td>
                    <nz-tag [nzColor]="user.isActive ? 'green' : 'red'">
                        {{ user.isActive ? 'Kích hoạt' : 'Không kích hoạt' }}
                    </nz-tag>
                </td>
            </tr>
        </tbody>
    </nz-table>

    <!-- Pagination -->
    <app-pagination [total]="totalItems" [pageSize]="pageSize" [pageIndex]="currentPage"
        (pageChange)="onPageChange($event)"></app-pagination>
</div>