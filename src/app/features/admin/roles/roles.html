<div class="roles-container">
    <div class="roles-header">
        <nz-row>
            <nz-col nzSpan="12">
                <h2>Vai trò</h2>
            </nz-col>
            <nz-col nzSpan="12" style="text-align: right;">
                <button nz-button nzType="primary" (click)="showCreateModal()">Tạo vai trò</button>
            </nz-col>
        </nz-row>

        <!-- Modal TẠO VAI TRÒ -->
        <nz-modal [(nzVisible)]="isCreateVisible" nzTitle="Tạo vai trò" (nzOnCancel)="handleCreateCancel()"
            [nzOkLoading]="isConfirmLoading" [nzFooter]="createFooter" nzClassName="custom-role-modal">

            <div *nzModalContent>
                <form #createRoleForm="ngForm">
                    <nz-form-item>
                        <nz-form-label [nzRequired]="true" nzFor="roleName">Tên vai trò</nz-form-label>
                        <nz-form-control [nzErrorTip]="'Tên vai trò là bắt buộc và không được trùng lặp.'">
                            <input nz-input id="roleName" name="roleName" [(ngModel)]="roleName"
                                #roleNameInput="ngModel" required placeholder="Nhập tên vai trò"
                                (ngModelChange)="checkRoleNameExists(roleNameInput)" />
                        </nz-form-control>
                    </nz-form-item>
                </form>
            </div>
        </nz-modal>


        <!-- Modal GÁN QUYỀN -->
        <nz-modal [(nzVisible)]="isAssignVisible" nzTitle="Permissions" (nzOnCancel)="handleAssignCancel()"
            [nzOkLoading]="isConfirmLoading" (nzOnOk)="handleAssignOk()" nzWidth="800px"
            nzWrapClassName="permissions-modal">

            <div *nzModalContent>
                <!-- Modal Header -->
                <div class="permissions-header">
                    <input nz-input placeholder="Tìm kiếm quyền..." />
                    <label  nz-checkbox [ngModel]="isAllSelected()" (ngModelChange)="toggleAllPermissions($event)">
                        Chọn tất cả
                    </label>
                </div>
                <div class="permissions-container">
                    <!-- Cột trái: danh sách module -->
                    <div class="permissions-sidebar">
                        <ul>
                            <li *ngFor="let group of groupedPermissions"
                                [class.active]="group.module === selectedModule"
                                (click)="selectedModule = group.module">
                                {{ group.module }}
                            </li>
                        </ul>
                    </div>

                    <!-- Cột phải: quyền theo module được chọn -->
                    <div class="permissions-content" *ngIf="selectedModule">
                        <h4>{{ selectedModule }}</h4>

                        <label style="color: #FFF;" nz-checkbox [ngModel]="isAllSelected(selectedModule)"
                            (ngModelChange)="toggleAllPermissions($event, selectedModule)">
                            Select all
                        </label>

                        <ul>
                            <li *ngFor="let perm of getPermissionsByModule(selectedModule)">
                                <label style="color: #FFF;" nz-checkbox [(ngModel)]="perm.granted"
                                    (ngModelChange)="allChecked = isAllSelected()">
                                    {{ perm.description }}
                                </label>
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
        </nz-modal>


        <!-- Footer Tạo vai trò -->
        <ng-template #createFooter>
            <button nz-button nzType="default" (click)="handleCreateCancel()">Hủy</button>
            <button nz-button nzType="primary" (click)="handleCreateOk()" [nzLoading]="isConfirmLoading" [disabled]="!roleName || roleNameExists">
                Lưu
            </button>
        </ng-template>

        <!-- Footer Gán quyền -->
        <ng-template #assignFooter>
            <button nz-button nzType="default" (click)="handleAssignCancel()">Hủy</button>
            <button nz-button nzType="primary" (click)="handleAssignOk()" [nzLoading]="isConfirmLoading">
                Lưu quyền
            </button>
        </ng-template>
    </div>

    <!-- Search box -->
    <div class="roles-search">
        <input nz-input placeholder="Tìm kiếm vai trò..." [(ngModel)]="searchQuery" />
        <button nz-button nzType="default" (click)="filterRoles()">Tìm kiếm</button>
    </div>

    <!-- Table roles -->
    <nz-table #roleTable [nzData]="pagedRoles" [nzFrontPagination]="false" ngClass="custom-table">
        <thead>
            <tr>
                <th nzWidth="15%" data-label="Actions">HÀNH ĐỘNG</th>
                <th nzWidth="60%" data-label="Role Name">TÊN VAI TRÒ</th>
                <th nzWidth="25%" data-label="User Count">SỐ NGƯỜI DÙNG</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let role of pagedRoles">
                <td data-label="Actions">
                    <a class="action-dropdown" nz-dropdown [nzDropdownMenu]="menu">
                        <nz-icon nzType="setting" nzTheme="outline" style="font-size: 16px; padding-right: 5px;" />Hành
                        động
                    </a>
                    <nz-dropdown-menu #menu="nzDropdownMenu">
                        <ul nz-menu>
                            <li nz-menu-item>
                                <button nz-button nzType="link" (click)="showAssignModal(role)">Gán quyền</button>
                            </li>
                            <li nz-menu-item>
                                <button nz-button nzType="link" (click)="deleteRole(role)">Xóa</button>
                            </li>
                            <li nz-menu-item>
                                <button nz-button nzType="link" (click)="editRole(role)">Sửa</button>
                            </li>
                        </ul>
                    </nz-dropdown-menu>
                </td>
                <td data-label="Role Name">{{ role.name }}</td>
                <td data-label="User Count">{{ role.userCount }}</td>
            </tr>
        </tbody>
    </nz-table>

    <!-- Pagination -->
    <div class="pagination-container">
        <span>Total: {{ totalItems }}</span>
        <nz-pagination [nzTotal]="totalItems" [(nzPageIndex)]="currentPage" [nzPageSize]="pageSize"
            (nzPageIndexChange)="onPageChange($event)" nzShowSizeChanger="false">
        </nz-pagination>
    </div>
</div>