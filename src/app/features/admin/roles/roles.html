<div class="roles-container">
  <!-- Header -->
  <div class="roles-header">
    <nz-row>
      <nz-col nzSpan="12">
        <h2>Vai trò</h2>
      </nz-col>
      <nz-col nzSpan="12" style="text-align: right;">
        <button nz-button nzType="primary" (click)="showCreateModal()">Tạo vai trò</button>
      </nz-col>
    </nz-row>

    <!-- Modal Tạo / Sửa vai trò -->
    <nz-modal
      [(nzVisible)]="isCreateVisible"
      nzTitle="{{ selectedRole ? 'Sửa vai trò' : 'Tạo vai trò' }}"
      (nzOnCancel)="handleCreateCancel()"
      [nzOkLoading]="isConfirmLoading"
      [nzFooter]="createFooter"
      nzClassName="custom-role-modal"
    >
      <div *nzModalContent>
        <form #createRoleForm="ngForm">
          <nz-form-item>
            <nz-form-label [nzRequired]="true" nzFor="roleName">Tên vai trò</nz-form-label>
            <nz-form-control [nzErrorTip]="'Tên vai trò là bắt buộc và không được trùng lặp.'">
              <input
                nz-input
                id="roleName"
                name="roleName"
                [(ngModel)]="roleName"
                #roleNameInput="ngModel"
                required
                placeholder="Nhập tên vai trò"
                [ngClass]="{'input-error': roleNameExists}"
                (ngModelChange)="onRoleNameChange($event)"
              />
            </nz-form-control>
          </nz-form-item>
        </form>
      </div>
    </nz-modal>

    <!-- Modal Gán quyền -->
    <app-assign-permission-modal
      [visible]="isAssignVisible"
      [role]="selectedRole"
      [groupedPermissions]="groupedPermissions"
      (cancel)="handleAssignCancel()"
      (save)="handleAssignOk($event)"
    ></app-assign-permission-modal>

    <!-- Footer Modal -->
    <ng-template #createFooter>
      <button nz-button nzType="default" (click)="handleCreateCancel()">Hủy</button>
      <button nz-button nzType="primary" (click)="handleCreateOk()" [nzLoading]="isConfirmLoading"
        [disabled]="!roleName || roleNameExists">
        Lưu
      </button>
    </ng-template>
  </div>

  <!-- Search box -->
  <div class="roles-search">
    <input nz-input placeholder="Tìm kiếm vai trò..." [(ngModel)]="searchQuery" />
    <button class="search-button" nz-button nzType="default" (click)="filterRoles()">Tìm kiếm</button>
  </div>

  <!-- Table roles -->
  <nz-table [nzData]="roles" [nzFrontPagination]="false" ngClass="custom-table">

    <thead>
      <tr>
        <th nzWidth="15%">Hành động</th>
        <th nzWidth="60%">Tên vai trò</th>
        <th nzWidth="25%">Số người dùng</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let role of roles">
        <td>
          <a class="action-dropdown" nz-dropdown [nzDropdownMenu]="menu">
            <nz-icon nzType="setting" nzTheme="outline" style="font-size: 16px; padding-right: 5px;"></nz-icon>Hành động
          </a>
          <nz-dropdown-menu #menu="nzDropdownMenu">
            <ul nz-menu>
              <li nz-menu-item>
                <button nz-button nzType="link" (click)="showAssignModal(role)" [disabled]="role.name === 'Admin'">Gán quyền</button>
              </li>
              <li nz-menu-item>
                <button nz-button nzType="link" (click)="deleteRole(role)" [disabled]="role.name === 'Admin'">Xóa</button>
              </li>
              <li nz-menu-item>
                <button nz-button nzType="link" (click)="editRole(role)" [disabled]="role.name === 'Admin'">Sửa</button>
              </li>
            </ul>
          </nz-dropdown-menu>
        </td>
        <td>{{ role.name }}</td>
        <td>{{ role.userCount }}</td>
      </tr>
    </tbody>
  </nz-table>

  <!-- Pagination -->
  <app-pagination
    [total]="totalItems"
    [pageSize]="pageSize"
    [pageIndex]="currentPage"
    (pageChange)="onPageChange($event)"
  ></app-pagination>
</div>
