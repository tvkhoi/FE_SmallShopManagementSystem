<div class="audit-log-container">
  <h2>Nhật ký hệ thống</h2>

  <div class="filter-container">
    <form nz-form nzLayout="vertical" class="filter-grid">
      <nz-form-item>
        <nz-form-label>Tên người dùng</nz-form-label>
        <nz-form-control>
          <input nz-input [(ngModel)]="userName" name="userName" placeholder="Tên người dùng" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>Hành động</nz-form-label>
        <nz-form-control>
          <input nz-input [(ngModel)]="action" name="action" placeholder="Hành động" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>Từ ngày</nz-form-label>
        <nz-form-control>
          <nz-date-picker [(ngModel)]="fromDate" name="fromDate"></nz-date-picker>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>Đến ngày</nz-form-label>
        <nz-form-control>
          <nz-date-picker [(ngModel)]="toDate" name="toDate"></nz-date-picker>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>Thời lượng tối thiểu</nz-form-label>
        <nz-form-control>
          <input nz-input type="number" [(ngModel)]="minDuration" name="minDuration"
            placeholder="Thời lượng tối thiểu" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>Thời lượng tối đa</nz-form-label>
        <nz-form-control>
          <input nz-input type="number" [(ngModel)]="maxDuration" name="maxDuration" placeholder="Thời lượng tối đa" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item class="filter-buttons" style="grid-column: span 4;">
        <button nz-button nzType="primary" (click)="filterLogs()" style="margin-right: 8px;">Làm mới</button>
      </nz-form-item>
    </form>
  </div>

  <!-- Modal: Xem chi tiết audit log -->
  <nz-modal [(nzVisible)]="isViewAuditDetailVisible" nzTitle="Chi tiết Audit Log" (nzOnCancel)="handleViewAuditDetailCancel()"
    [nzWidth]="800" [nzBodyStyle]="{ 'max-height': '60vh', 'overflow-y': 'auto', 'padding': '16px' }"
    [nzFooter]="auditDetailFooter">
    <div *nzModalContent class="audit-detail-grid">
      <div class="detail-item">
        <span class="label">ID người dùng:</span>
        <span class="value">{{ selectedLog?.userId }}</span>
      </div>
      <div class="detail-item">
        <span class="label">Tên người dùng:</span>
        <span class="value">{{ selectedLog?.userName }}</span>
      </div>
      <div class="detail-item">
        <span class="label">Yêu cầu:</span>
        <span class="value">{{ selectedLog?.action }}</span>
      </div>
      <div class="detail-item">
        <span class="label">Ngày tạo:</span>
        <span class="value">{{ selectedLog?.createdAt | date:'dd/MM/yyyy HH:mm:ss' }}</span>
      </div>
      <div class="detail-item">
        <span class="label">Thời gian (ms):</span>
        <span class="value">{{ selectedLog?.duration }}</span>
      </div>
      <div class="detail-item">
        <span class="label">Tên ứng dụng:</span>
        <span class="value">{{ selectedLog?.applicationName }}</span>
      </div>
      <div class="detail-item" style="grid-column: span 2;">
        <span class="label">Dữ liệu:</span>
        <span class="value" style="white-space: pre-wrap;">{{ selectedLog?.data }}</span>
      </div>
    </div>
  </nz-modal>

  <ng-template #auditDetailFooter>
    <button nz-button nzType="primary" (click)="handleViewAuditDetailCancel()">Đóng</button>
  </ng-template>


  <nz-table [nzData]="auditLogs" nzSize="small" [nzScroll]="{ x: '100%', y: 'calc(100vh - 400px)' }" class="audit-table"
    [nzLoading]="loading" nzShowPagination="false">
    <thead>
      <tr>
        <th>Hành động</th>
        <th>Yêu cầu</th>
        <th>Người dùng</th>
        <th>Ngày</th>
        <th>Thời gian</th>
        <th>Tên ứng dụng</th>
        <th>Dữ liệu</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let log of auditLogs">
        <td>
          <button nz-button class="view-detail-button" nzType="primary" (click)="viewAuditDetail(log)">Xem chi
            tiết</button>
        </td>
        <td>{{ log.action }}</td>
        <td>{{ log.userName }}</td>
        <td>{{ log.createdAt | date: "dd-MM-yyyy HH:mm:ss" }}</td>
        <td>{{ log.duration }}</td>
        <td>{{ log.applicationName }}</td>
        <td>
          <span nz-tooltip [nzTooltipTitle]="log.data ?? ''">
            {{ log.data ? (log.data | slice:0:50) : '' }}
            <span *ngIf="log.data && log.data.length > 50">...</span>
          </span>
        </td>


      </tr>
    </tbody>
  </nz-table>

  <nz-pagination [nzTotal]="totalItems" [(nzPageIndex)]="currentPage" [nzPageSize]="pageSize"
    (nzPageIndexChange)="onPageChange($event)" (nzPageSizeChange)="onPageSizeChange($event)" nzShowSizeChanger
    [nzPageSizeOptions]="[5,10,20]">
  </nz-pagination>
</div>