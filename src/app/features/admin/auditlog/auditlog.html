<div class="audit-log-container">
  <h2>Nhật ký hệ thống</h2>

  <div class="filter-container">
    <form nz-form nzLayout="vertical" class="filter-grid">
      <nz-form-item>
        <nz-form-label>Tên người dùng</nz-form-label>
        <nz-form-control>
          <input nz-input [(ngModel)]="userName" name="userName" placeholder="Tên người dùng" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>Hành động</nz-form-label>
        <nz-form-control>
          <input nz-input [(ngModel)]="action" name="action" placeholder="Hành động" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>Từ ngày</nz-form-label>
        <nz-form-control>
          <nz-date-picker [(ngModel)]="fromDate" name="fromDate"></nz-date-picker>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>Đến ngày</nz-form-label>
        <nz-form-control>
          <nz-date-picker [(ngModel)]="toDate" name="toDate"></nz-date-picker>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>Thời lượng tối thiểu</nz-form-label>
        <nz-form-control>
          <input nz-input type="number" [(ngModel)]="minDuration" name="minDuration"
            placeholder="Thời lượng tối thiểu" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>Thời lượng tối đa</nz-form-label>
        <nz-form-control>
          <input nz-input type="number" [(ngModel)]="maxDuration" name="maxDuration" placeholder="Thời lượng tối đa" />
        </nz-form-control>
      </nz-form-item>


      <nz-form-item class="filter-buttons" style="grid-column: span 4;">
        <button nz-button nzType="primary" (click)="filterLogs()" style="margin-right: 8px;">Làm mới</button>
        <button nzType="primary" style="background-color: red; border: none; transition: opacity 0.2s;"
          onmouseover="this.style.opacity=0.8" onmouseout="this.style.opacity=1" nz-button nz-dropdown
          [nzDropdownMenu]="menu">
          Xóa <nz-icon nzType="down"></nz-icon>
        </button>

        <!-- Dropdown xóa log -->
        <nz-dropdown-menu #menu="nzDropdownMenu">
          <ul nz-menu>
            <li nz-menu-item (click)="clearAllLogs()">Xóa hết</li>
            <li nz-menu-item (click)="openClearOldModal()">Xóa theo ngày</li>
          </ul>
        </nz-dropdown-menu>

        <nz-modal [(nzVisible)]="isClearOldVisible" nzTitle="Xóa log theo ngày" (nzOnCancel)="isClearOldVisible = false"
          (nzOnOk)="confirmClearOld()">
          <div *nzModalContent>
            <label>Số ngày giữ lại (VD: 30)</label>
            <input nz-input type="number" [(ngModel)]="clearOldDays" min="1" />
          </div>
        </nz-modal>
      </nz-form-item>


      <nz-form-item>
        <nz-form-label>Phương thức HTTP</nz-form-label>
        <nz-form-control>
          <nz-select [(ngModel)]="method" name="method" nzAllowClear placeholder="Chọn phương thức"
            (ngModelChange)="onMethodChange($event)">
            <nz-option nzValue="GET" nzLabel="GET"></nz-option>
            <nz-option nzValue="POST" nzLabel="POST"></nz-option>
            <nz-option nzValue="PUT" nzLabel="PUT"></nz-option>
            <nz-option nzValue="DELETE" nzLabel="DELETE"></nz-option>
            <nz-option nzValue="PATCH" nzLabel="PATCH"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>Mã trạng thái</nz-form-label>
        <nz-form-control>
          <input nz-input type="number" [(ngModel)]="statusCode" name="statusCode" placeholder="VD: 200, 404, 500" />
        </nz-form-control>
      </nz-form-item>
    </form>
  </div>

  <!-- Modal: Xem chi tiết audit log -->
  <nz-modal [(nzVisible)]="isViewAuditDetailVisible" nzTitle="Chi tiết Audit Log"
    (nzOnCancel)="handleViewAuditDetailCancel()" [nzWidth]="800"
    [nzBodyStyle]="{ 'max-height': '60vh', 'overflow-y': 'auto', 'padding': '16px' }" [nzFooter]="auditDetailFooter">
    <div *nzModalContent>
      <table class="details-table">
        <!-- <tr>
          <td class="label">ID người dùng</td>
          <td>{{ selectedLog?.userId }}</td>
        </tr> -->
        <tr>
          <td class="label">Tên người dùng</td>
          <td>{{ selectedLog?.userName }}</td>
        </tr>
        <tr>
          <td class="label">Mã trạng thái HTTP</td>
          <td>
            <span class="request-status" [ngStyle]="{ 'background-color': getStatusColor(selectedLog?.statusCode) }">
              {{ selectedLog?.statusCode }}
            </span>
          </td>
        </tr>
        <tr>
          <td class="label">Phương thức HTTP</td>
          <td>
            <span class="request-method" [ngStyle]="{ 'background-color': getMethodColor(selectedLog?.method) }">
              {{ selectedLog?.method }}
            </span>
          </td>

        </tr>
        <tr>
          <td class="label">URL</td>
          <td><span class="request-path">{{ selectedLog?.path }}</span></td>
        </tr>
        <tr>
          <td class="label">Ngày tạo</td>
          <td>{{ selectedLog?.createdAt | date:'dd/MM/yyyy HH:mm:ss' }}</td>
        </tr>
        <tr>
          <td class="label">Thời gian (ms)</td>
          <td>{{ selectedLog?.duration }}</td>
        </tr>
        <tr>
          <td class="label">Tên ứng dụng</td>
          <td>{{ selectedLog?.applicationName }}</td>
        </tr>
        <tr>
          <td class="label">Dữ liệu</td>
          <td class="address-cell">
            <span nz-tooltip [nzTooltipTitle]="selectedLog?.data ?? ''">
              {{ selectedLog?.data ? (selectedLog?.data | slice:0:8) : '' }}
            </span>
          </td>
        </tr>
      </table>
    </div>
  </nz-modal>

  <ng-template #auditDetailFooter>
    <button style="width: 100%;" nz-button nzType="primary" (click)="handleViewAuditDetailCancel()">Đóng</button>
  </ng-template>


  <nz-table [nzData]="auditLogs" nzSize="small" [nzScroll]="{ x: '100%', y: 'calc(100vh - 200px)' }"
    class="audit-table nowrap-table" [nzLoading]="loading" nzShowPagination="false">

    <thead>
      <tr>
        <th nzWidth="120px">Hành động</th>
        <th nzWidth="600px">Yêu cầu</th>
        <th nzWidth="150px">Người dùng</th>
        <th nzWidth="180px">Ngày</th>
        <th nzWidth="100px">Thời gian</th>
        <th nzWidth="120px">Dữ liệu</th>
        <th nzWidth="200px">Tên ứng dụng</th>
      </tr>
    </thead>


    <tbody>
      <tr *ngFor="let log of auditLogs">
        <td>
          <button nz-button nzType="primary" class="view-detail-button" nzType="primary" (click)="viewAuditDetail(log)">
            <span nz-icon nzType="eye" nzTheme="outline"></span>
            Chi tiết
          </button>
        </td>

        <td class="request-cell">
          <span class="request-status" [ngStyle]="{ 'background-color': getStatusColor(log.statusCode) }">
            {{ log.statusCode }}
          </span>

          <span class="request-method" [ngStyle]="{ 'background-color': getMethodColor(log.method) }">
            {{ log.method }}
          </span>

          <span class="request-path">{{ log.path }}</span>
        </td>

        <td>{{ log.userName }}</td>
        <td>{{ log.createdAt | date: "dd-MM-yyyy HH:mm:ss" }}</td>
        <td>{{ log.duration }}</td>
        <td>
          <span nz-tooltip [nzTooltipTitle]="log.data ?? ''">
            {{ log.data ? (log.data | slice:0:8) : '' }}
          </span>
        </td>
        <td>{{ log.applicationName }}</td>
      </tr>
    </tbody>
  </nz-table>



  <nz-pagination class="audit-pagination" [nzTotal]="totalItems" [(nzPageIndex)]="currentPage" [nzPageSize]="pageSize"
    (nzPageIndexChange)="onPageChange($event)" (nzPageSizeChange)="onPageSizeChange($event)" nzShowSizeChanger
    [nzPageSizeOptions]="[5,10,20]">
  </nz-pagination>
</div>