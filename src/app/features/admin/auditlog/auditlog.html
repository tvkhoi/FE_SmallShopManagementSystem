<div class="audit-log-container">
  <h2>Nhật ký hệ thống</h2>

  <div class="filter-container">
    <form nz-form nzLayout="vertical">
      <div nz-row [nzGutter]="16">
        <!-- Tên người dùng -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6">
          <nz-form-item>
            <nz-form-label>Tên người dùng</nz-form-label>
            <nz-form-control>
              <input nz-input [(ngModel)]="userName" name="userName" placeholder="Tên người dùng"
                [ngModelOptions]="{standalone: true}" />
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Từ ngày -->
        <div nz-col [nzXs]="12" [nzSm]="12" [nzMd]="8" [nzLg]="6">
          <nz-form-item>
            <nz-form-label>Từ ngày</nz-form-label>
            <nz-form-control>
              <nz-date-picker nzPlaceHolder="Chọn ngày" [(ngModel)]="fromDate" name="fromDate"
                [ngModelOptions]="{ standalone: true }" nzFormat="dd-MM-yyyy">
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Đến ngày -->
        <div nz-col [nzXs]="12" [nzSm]="12" [nzMd]="8" [nzLg]="6">
          <nz-form-item>
            <nz-form-label>Đến ngày</nz-form-label>
            <nz-form-control>
              <nz-date-picker nzPlaceHolder="Chọn ngày" [(ngModel)]="toDate" name="toDate"
                [ngModelOptions]="{ standalone: true }" nzFormat="dd-MM-yyyy">
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Thời lượng tối thiểu -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6">
          <nz-form-item>
            <nz-form-label>Thời lượng tối thiểu</nz-form-label>
            <nz-form-control>
              <input nz-input type="number" [(ngModel)]="minDuration" name="minDuration"
                placeholder="Thời lượng tối thiểu" />
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Thời lượng tối đa -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6">
          <nz-form-item>
            <nz-form-label>Thời lượng tối đa</nz-form-label>
            <nz-form-control>
              <input nz-input type="number" [(ngModel)]="maxDuration" name="maxDuration"
                placeholder="Thời lượng tối đa" />
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Phương thức HTTP -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6">
          <nz-form-item>
            <nz-form-label>Phương thức HTTP</nz-form-label>
            <nz-form-control>
              <nz-select nzSize="large" style="width: 100%;" [(ngModel)]="method" name="method" nzAllowClear
                placeholder="Chọn phương thức" (ngModelChange)="onMethodChange($event)">
                <nz-option nzValue="GET" nzLabel="GET"></nz-option>
                <nz-option nzValue="POST" nzLabel="POST"></nz-option>
                <nz-option nzValue="PUT" nzLabel="PUT"></nz-option>
                <nz-option nzValue="DELETE" nzLabel="DELETE"></nz-option>
                <nz-option nzValue="PATCH" nzLabel="PATCH"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Mã trạng thái -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6">
          <nz-form-item>
            <nz-form-label>Mã trạng thái</nz-form-label>
            <nz-form-control>
              <input nz-input type="number" [(ngModel)]="statusCode" name="statusCode"
                placeholder="VD: 200, 404, 500" />
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Buttons -->
        <div nz-col [nzSpan]="24" class="filter-buttons">
          <button nz-button nzType="primary" type="button" (click)="resetFilters()" style="margin-right: 8px;">Làm
            mới</button>
          <button nz-button nzType="primary" type="button" (click)="exportLogs()" style="margin-right: 8px;">Xuất
            Excel</button>
          <button nz-button nzType="primary" type="button" (click)="filterLogs()">Lọc</button>
        </div>
      </div>
    </form>
  </div>


  <!-- Modal: Xem chi tiết audit log -->
  <nz-modal [(nzVisible)]="isViewAuditDetailVisible" nzTitle="Chi tiết Audit Log"
    (nzOnCancel)="handleViewAuditDetailCancel()" [nzWidth]="800"
    [nzBodyStyle]="{ 'max-height': '60vh', 'overflow-y': 'auto', 'padding': '16px' }" [nzFooter]="auditDetailFooter">
    <div *nzModalContent>
      <table class="details-table">
        <thead>
          <tr>
            <th>Thuộc tính</th>
            <th>Giá trị</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="label">Tên người dùng</td>
            <td>{{ selectedLog?.userName }}</td>
          </tr>
          <tr>
            <td class="label">Mã trạng thái HTTP</td>
            <td>
              <span class="request-status" [ngStyle]="{ 'background-color': getStatusColor(selectedLog?.statusCode) }">
                {{ selectedLog?.statusCode }}
              </span>
            </td>
          </tr>
          <tr>
            <td class="label">Phương thức HTTP</td>
            <td>
              <span class="request-method" [ngStyle]="{ 'background-color': getMethodColor(selectedLog?.method) }">
                {{ selectedLog?.method }}
              </span>
            </td>

          </tr>
          <tr>
            <td class="label">URL</td>
            <td><span class="request-path">{{ selectedLog?.path }}</span></td>
          </tr>
          <tr>
            <td class="label">Ngày tạo</td>
            <td>{{ selectedLog?.createdAt | date:'dd/MM/yyyy HH:mm:ss' }}</td>
          </tr>
          <tr>
            <td class="label">Thời gian (ms)</td>
            <td>{{ selectedLog?.duration }}</td>
          </tr>
          <tr>
            <td class="label">Tên ứng dụng</td>
            <td>{{ selectedLog?.applicationName }}</td>
          </tr>
          <tr>
            <td class="label">Dữ liệu</td>
            <td class="address-cell">
              <span nz-tooltip [nzTooltipTitle]="selectedLog?.data ?? ''">
                {{ selectedLog?.data ? (selectedLog?.data | slice:0:8) : '' }}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </nz-modal>

  <ng-template #auditDetailFooter>
    <button style="width: 100%;" nz-button nzType="primary" (click)="handleViewAuditDetailCancel()">Đóng</button>
  </ng-template>

  <div class="audit-table-container">
    <nz-table #table [nzData]="auditLogs" nzSize="small" [nzScroll]="{ x: '1200px', y: 'calc(100vh - 200px)' }"
      class="audit-table nowrap-table" [nzLoading]="loading" nzShowPagination="false">

      <thead>
        <tr>
          <th scope="col" nzWidth="120px">Hành động</th>
          <th scope="col" nzWidth="600px" nzShowSort [nzSortFn]="sortByRequest">Yêu cầu</th>
          <th scope="col" nzWidth="150px" nzShowSort [nzSortFn]="sortByUserName">Người dùng</th>
          <th scope="col" nzWidth="180px" nzShowSort [nzSortFn]="sortByDate">Ngày</th>
          <th scope="col" nzWidth="100px" nzShowSort [nzSortFn]="sortByDuration">Thời gian</th>
          <th scope="col" nzWidth="120px" nzShowSort [nzSortFn]="sortByData">Dữ liệu</th>
          <th scope="col" nzWidth="200px" nzShowSort [nzSortFn]="sortByAppName">Tên ứng dụng</th>
        </tr>
      </thead>


      <tbody>
        <tr *ngFor="let log of table.data">
          <td>
            <button nz-button nzType="primary" class="view-detail-button" nzType="primary"
              (click)="viewAuditDetail(log)">
              <span nz-icon nzType="eye" nzTheme="outline"></span>
              Chi tiết
            </button>
          </td>

          <td class="request-cell">
            <span class="request-status" [ngStyle]="{ 'background-color': getStatusColor(log.statusCode) }">
              {{ log.statusCode }}
            </span>

            <span class="request-method" [ngStyle]="{ 'background-color': getMethodColor(log.method) }">
              {{ log.method }}
            </span>

            <span class="request-path">{{ log.path }}</span>
          </td>

          <td>{{ log.userName }}</td>
          <td>{{ log.createdAt | date: "dd-MM-yyyy HH:mm:ss" }}</td>
          <td>{{ log.duration }}</td>
          <td>
            <span nz-tooltip [nzTooltipTitle]="log.data ?? ''">
              {{ log.data ? (log.data | slice:0:8) : '' }}
            </span>
          </td>
          <td>{{ log.applicationName }}</td>
        </tr>
      </tbody>
    </nz-table>
  </div>

  <!-- Pagination -->
  <app-pagination [total]="totalItems" [pageSize]="pageSize" [pageIndex]="currentPage"
    (pageChange)="onPageChange($event)" (pageSizeChange)="onPageSizeChange($event)"></app-pagination>
</div>